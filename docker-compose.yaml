services:
  library:
    image: postgres:latest
    container_name: library
    env_file: .env
    ports:
      - "5432:5432"
    volumes:
      - data:/var/lib/postgresql/data
    restart: unless-stopped

  proxy:
    image: mitmproxy/mitmproxy:latest
    container_name: proxy
    entrypoint: /bin/sh -c "chmod +x /home/mitmproxy/override.sh && /home/mitmproxy/override.sh"  
    env_file: .env
    ports:
        - "8888:8080"
    volumes:
        - ./proxy/addon.py:/home/mitmproxy/addon.py
        - ./proxy/override.sh:/home/mitmproxy/override.sh
    depends_on:
      - archiver
    restart: unless-stopped

  librarian:
    image: librarian:latest
    container_name: librarian
    env_file: .env
    build:
      context: .
      target: librarian
      dockerfile: Dockerfile
      args:
        PACKAGE_NAME: librarian
    restart: unless-stopped

  archiver:
    image: archiver:latest
    container_name: archiver
    env_file: .env
    build:
      context: .
      target: archiver
      dockerfile: Dockerfile
      args:
        PACKAGE_NAME: archiver
    depends_on:
      - library
    restart: unless-stopped

volumes:
  data:
    driver: local
